# How to Create a multi-node GrayLog.

Steps:
* Install needed component
* Setup MongoDB
* Setup Cluster ElasticSearch
* Setup GrayLog Server for multi-node
* Done!!!

## Install needed component

Please followed [graylog official](https://www.graylog.org/) and [Documentation](http://docs.graylog.org/) for details.

## Setup MongoDB

* Create replica set (Must)

First setup the mongo config for enviorment.

```shell
# change in all nodes.
# Located in "/etc/mongod.conf"

net:
  port: 27018
  bindIp: 0.0.0.0
[因
replication:
   replSetName: "rs01"
```

Then go to the master node you want. log into MongoDB.

Setup the replica claster using following command one by one.

```shell
mongo --port 27018
rs.initiate()
rs.add("<hostname>:27018") # add each node by changing <hostname>
rs.status()
```

That's it!

* Create DB (Must)

Go to the master node you want. log into MongoDB.

```shell
mongo --port 27018
use graylog
```

Done.

* Edit Services if needed

Than Change the service config if needed.

```shell
# Location : /usr/lib/systemd/system/mongod.service

Restart=on-failure
[因
[Install]
WantedBy=multi-user.target
```

* Create user(optical)

```shell
$ mongo admin -u admin -p admin --eval "db.getSiblingDB('dummydb').addUser('dummyuser', 'dummysecret')"
```

## Setup Cluster ElasticSearch

* performance arrange
 
Changing the HEAP_SIZE for your elasticsearch performance.

```shell
# chang it in file located:/etc/sysconfig/elasticsearch
ES_HEAP_SIZE=31g # not grater than 31g, suggest 50% of your mem size
```

* Cluster build-up config

Build up the multi-node using belows config.

```shell
# file location: /etc/elasticsearch/elasticsearch.yml

cluster.name: <Cluster-Name> #Choose a name you want, any cluster should be same.
node.name: <Node-Name> #Choose a name you want, should different for each node.
network.host: 0.0.0.0
http.port: 9200
transport.tcp.port: 9300
discovery.zen.ping.multicast.enabled: false
discovery.zen.ping.unicast.hosts: ["<host>:9300" , "<host>:9300" , "<host>:9300"] # multi-node used, mostly support
                                                                       # up to 3 nodes. Every nodes use same config.
cluster.routing.allocation.same_shard.host: true
index.refresh_interval: 30s
```

* arrange the service if need

```shell
# file location: /usr/lib/systemd/system/elasticsearch.service

[因
[Service]
Restart=on-failure # add new line.
[因
```

* check service 

check service is started and the multi-node is work.

```bash
# curl -XGET 'http://localhost:9200/_cluster/health?pretty=true'

{
  "cluster_name" : "<Claster-Name>",
  "status" : "green",
  "timed_out" : false,
  "number_of_nodes" : 3,           << Important!!!
  "number_of_data_nodes" : 3,      << Important!!!
  "active_primary_shards" : 0,
  "active_shards" : 0,
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 0,
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 100.0
}
```

## Setup GrayLog Server for multi-node

* Porformance up

Change the JVM heap size by HW mem. If large enough, 14G is the recommand.

```shell
# file location is : /etc/sysconfig/graylog-server

GRAYLOG_SERVER_JAVA_OPTS="-Xms14g -Xmx14g [...]
```

* config the Graylog-Server as cluster

Be aware of the configs below.

```shell
# File location is here: /etc/graylog/server/server.conf

is_master = true      # only the master node is true, other please use false
web_enable = false    # if you want to disable non-master node web access, use this.
elasticsearch_cluster_name = <Cluster-Name>             # should be same as what is define in elasticsearch
password_secret = lCBlLe1qJkPsZfSKVJy1fFKY1HngWsIVKCMQwJaL8RXe36Y47quq7NgyPWvAH4sIYUIoGpB2NFKYUw9S0WhFy8mkLzxEaS2f    # generated by the command: echo "password_secret = `tr -dc A-Za-z0-9 </dev/urandom | head -c96`" >> /etc/graylog/server/server.conf
root_password_sha2 = 5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8                                 # generated by the command: echo "root_password_sha2 = `echo -n 'password' | sha256sum | tr - \ `" >> /etc/graylog/server/server.conf
web_listen_uri = http://0.0.0.0:9000/
rest_listen_uri = http://0.0.0.0:12900/
message_journal_dir = /var/lib/graylog-server/journal
plugin_dir = /usr/share/graylog-server/plugin
node_id_file = /etc/graylog/server/node-id
usage_statics_enabled = false
output-batch_size = 1000
elasticsearch_shards = 4
elasticsearch_replicas = 1

## Add-on settings
message_journal_enabled = true
content_packs_dir = /usr/share/graylog-server/contentpacks
content_packs_auto_load = grok-patterns.json
elasticsearch_discovery_zen_ping_unicast_hosts = <host>:9300, <hostname>:9300, <hostname>:9300          # change <hostname> and add all your nodes here
elasticsearch_network_host = <host_ipaddress>                   # AWARE: this is put the IP address for the host, each node is different
root_timezone = ROC             # change it if you use different timezone

## Define MongoDB location
mongodb_uri = mongodb://<hostname>:27018,<hostname>:27018,<hostname>:27018/graylog?replicaSet=rs01   # VERY IMPORTANT, change <hostname> to every nodes you have and if replicaSet name you use in the steps before is not "rs01", please change it. each node are same settings. 
```

DONE!

